<%- include('../partes/header') %>

<h1>Panel de Administración</h1>

<a href="/admin/crearJuego">Agregar Nuevo Juego</a> 
<a href="/admin/crearGiftCard">Agregar Nueva GiftCard</a> 
<a href="/admin/panelVentas">Ver ventas</a> 
<a href="/logout">Cerrar Sesión</a>


<h2>Juegos</h2>
<table>
  <thead>
    <tr><th>Nombre</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr>
  </thead>
  <tbody>
    <% juegos.forEach(juego => { %>
      <tr>
        <td><%= juego.nombre %></td>
        <td>$<%= juego.precio %></td>
        <td><%= juego.activo ? 'Activo' : 'Inactivo' %></td>
        <td>
          <a href="/admin/editarJuego/<%= juego.id %>">Editar</a> 
          <% if (juego.activo) { %>
            <button onclick="cambiarEstadoJuego(<%= juego.id %>, false)">Desactivar</button>
          <% } else { %>
            <button onclick="cambiarEstadoJuego(<%= juego.id %>, true)">Reactivar</button>
          <% } %>
        </td>
      </tr>
    <% }) %>
  </tbody>
</table>


<h2>GiftCards</h2>
<table>
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
  <% if (giftcards && giftcards.length > 0) { %>
    <% giftcards.forEach(giftcard => { %>
      <tr>
        <td><%= giftcard.nombre %></td>
        <td>$<%= giftcard.precio %></td>
        <td><%= giftcard.activo ? 'Activo' : 'Inactivo' %></td>
        <td>
          <a href="/admin/editarGiftCard/<%= giftcard.id %>">Editar</a> 
          <% if (giftcard.activo) { %>
            <button onclick="cambiarEstadoGiftCard(<%= giftcard.id %>, false)">Desactivar</button>
          <% } else { %>
            <button onclick="cambiarEstadoGiftCard(<%= giftcard.id %>, true)">Reactivar</button>
          <% } %>
        </td>
      </tr>
    <% }) %>
  <% } else { %>
    <tr><td colspan="4">No hay GiftCards disponibles</td></tr>
  <% } %>
</tbody>
</table>


<script>
  const token = '<%= token %>';  // Token JWT pasado desde el servidor

    async function cambiarEstadoJuego(juegoId, activar) {
    try {
      const url = activar ? `/api/juegos/${juegoId}/activar` : `/api/juegos/${juegoId}`;
      const method = activar ? 'PUT' : 'DELETE';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        alert('Error: ' + (errorData.message || 'Error al cambiar estado'));
        return;
      }

      alert(`Juego ${activar ? 'reactivado' : 'desactivado'} correctamente`);
      location.reload();

    } catch (err) {
      console.error(err);
      alert('Error de red o servidor');
    }
  }

  async function cambiarEstadoGiftCard(giftcardId, activar) {
  try {
    const url = activar
      ? `/api/giftcards/${giftcardId}/activar`
      : `/api/giftcards/${giftcardId}`;
    const method = activar ? 'PUT' : 'DELETE';

    const response = await fetch(url, {
      method,
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      // Intentar leer el error como json
      let errorData;
      try {
        errorData = await response.json();
      } catch {
        errorData = { message: 'No se pudo interpretar el error del servidor' };
      }
      // Mostrar mensaje específico si existe o el objeto completo
      alert('Error: ' + (errorData.message || JSON.stringify(errorData)));
      return;
    }

    alert(`GiftCard ${activar ? 'reactivada' : 'desactivada'} correctamente`);
    location.reload();

  } catch (err) {
    console.error(err);
    alert('Error de red o servidor: ' + err.message);
  }
}
</script>

<%- include('../partes/footer') %>
